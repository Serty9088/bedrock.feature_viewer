<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Minecraft Features Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1b1f2f;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 280px;
            background: #232946;
            color: #fff;
            overflow-y: auto;
            padding: 20px;
            border-right: 2px solid #2e3a62;
        }
        .sidebar h2 {
            margin-top: 0;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .feature-list li {
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #303a61;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, border 0.2s;
            border: 2px solid transparent;
        }
        .feature-list li:hover {
            background: #3c4875;
        }
        .feature-list li.active {
            background: #5c6bc0;
        }
        .feature-list li.has-rule {
            border: 2px solid #8e9dff;
        }
        .main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #161a28;
        }
        .card {
            background: #232946;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-width: 1000px;
            margin: auto;
        }
        .card h2 {
            margin-top: 0;
            color: #aab4ff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            color: #e0e0e0;
        }
        th, td {
            border: 1px solid #2e3a62;
            padding: 8px;
            text-align: center;
        }
        th {
            background: #2a3155;
        }
        input[type="number"] {
            width: 80px;
            padding: 4px;
            background: #161a28;
            color: #fff;
            border: 1px solid #444b7a;
            border-radius: 4px;
        }
        .slider {
            width: 120px;
        }
        .actions {
            margin-top: 20px;
            text-align: right;
        }
        button {
            margin-left: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #5c6bc0;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover {
            background: #3f4a99;
        }
        .danger {
            background: #e63946;
        }
        .danger:hover {
            background: #c62839;
        }
        .reset {
            background: #6a4c93;
        }
        .reset:hover {
            background: #523576;
        }
        .controls {
            text-align: center;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Features</h2>
        <div class="controls">
            <input type="file" id="fileInput" multiple>
            <button onclick="downloadAll()">Скачать все</button>
        </div>
        <ul class="feature-list" id="featureList"></ul>
    </div>
    <div class="main">
        <div id="cardContainer"></div>
    </div>

    <script>
        let features = {};
        let rules = {};
        let originalWeights = {};
        let activeFeature = null;

        document.getElementById('fileInput').addEventListener('change', handleFiles);

        function handleFiles(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data['minecraft:weighted_random_feature']) {
                            const f = data['minecraft:weighted_random_feature'];
                            features[f.description.identifier] = {
                                identifier: f.description.identifier,
                                features: f.features,
                                raw: data
                            };
                            originalWeights[f.description.identifier] = f.features.map(x => x[1]);
                        } else if (data['minecraft:feature_rules']) {
                            const r = data['minecraft:feature_rules'];
                            rules[r.description.places_feature] = {
                                identifier: r.description.identifier,
                                places_feature: r.description.places_feature,
                                iterations: r.distribution?.iterations ?? 1,
                                scatter_chance: r.distribution?.scatter_chance ?? 100
                            };
                        }
                    } catch (err) {
                        console.error("Ошибка чтения файла", err);
                    }
                    renderFeatureList();
                };
                reader.readAsText(file);
            });
        }

        function renderFeatureList() {
            const list = document.getElementById('featureList');
            list.innerHTML = '';
            Object.values(features).forEach(f => {
                const li = document.createElement('li');
                li.textContent = f.identifier;
                if (rules[f.identifier]) {
                    li.classList.add('has-rule');
                }
                if (f.identifier === activeFeature) {
                    li.classList.add('active');
                }
                li.onclick = () => {
                    activeFeature = f.identifier;
                    renderFeatureList();
                    renderCard(f);
                };
                list.appendChild(li);
            });
        }

        function renderCard(f) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            const rule = rules[f.identifier];
            const frequency = rule ? (rule.iterations * (rule.scatter_chance / 100)) : null;

            const card = document.createElement('div');
            card.className = 'card';

            const title = document.createElement('h2');
            title.textContent = f.identifier;
            card.appendChild(title);

            const freqElem = document.createElement('p');
            freqElem.textContent = frequency !== null ? `Частота: ${frequency}` : 'Частота: нет правила';
            card.appendChild(freqElem);

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Feature</th>
                    <th>Вес</th>
                    <th>%</th>
                    <th>Общая частота</th>
                    <th>Фикс.</th>
                    <th>Слайдер</th>
                </tr>`;
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);

            const ctx = document.createElement('canvas');
            card.appendChild(ctx);
            card.appendChild(table);

            const actions = document.createElement('div');
            actions.className = 'actions';

            const btnReset = document.createElement('button');
            btnReset.textContent = 'Вернуть значения';
            btnReset.className = 'reset';
            btnReset.onclick = () => {
                weights = [...originalWeights[f.identifier]];
                normalize(weights);
                updateDisplay();
            };
            actions.appendChild(btnReset);

            const btnSave = document.createElement('button');
            btnSave.textContent = 'Скачать';
            btnSave.onclick = () => downloadFeature(f.identifier);
            actions.appendChild(btnSave);

            const btnDelete = document.createElement('button');
            btnDelete.textContent = 'Удалить';
            btnDelete.className = 'danger';
            btnDelete.onclick = () => {
                if (confirm('Удалить эту карточку?')) {
                    delete features[f.identifier];
                    renderFeatureList();
                    container.innerHTML = '';
                }
            };
            actions.appendChild(btnDelete);
            card.appendChild(actions);

            container.appendChild(card);

            let rows = [];
            let weights = f.features.map(x => x[1]);
            normalize(weights);

            f.features.forEach((feat, i) => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = feat[0];

                const weightTd = document.createElement('td');
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.value = weights[i];

                weightTd.appendChild(weightInput);

                const percentTd = document.createElement('td');
                const percentInput = document.createElement('input');
                percentInput.type = 'number';
                percentInput.step = 0.05;
                percentInput.value = ((weights[i]/100000)*100).toFixed(2);

                percentTd.appendChild(percentInput);

                const freqTd = document.createElement('td');

                const fixTd = document.createElement('td');
                const fixCheck = document.createElement('input');
                fixCheck.type = 'checkbox';
                fixTd.appendChild(fixCheck);

                const sliderTd = document.createElement('td');
                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = 0;
                slider.max = 100000;
                slider.step = Math.max(1, Math.round(weights[i]/50));
                slider.value = weights[i];
                slider.className = 'slider';
                sliderTd.appendChild(slider);

                tr.appendChild(nameTd);
                tr.appendChild(weightTd);
                tr.appendChild(percentTd);
                tr.appendChild(freqTd);
                tr.appendChild(fixTd);
                tr.appendChild(sliderTd);
                tbody.appendChild(tr);

                rows.push({weightInput, percentInput, freqTd, fixCheck, slider, name: feat[0]});
            });

            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: rows.map(r => r.name),
                    datasets: [{
                        data: weights,
                        backgroundColor: rows.map((_, i) => `hsl(${i * 40 % 360},70%,60%)`)
                    }]
                },
                options: {
                    plugins: {
                        tooltip: {
                            bodyFont: {
                                size: 16
                            },
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const w = weights[index];
                                    const sum = weights.reduce((a,b) => a+b,0);
                                    const percent = (w/sum*100).toFixed(2);
                                    const freq = frequency !== null ? String(Number(((frequency * percent)/100).toFixed(8))) : '-';
                                    return `${rows[index].name}: ${w} (${percent}%, частота: ${freq})`;
                                }
                            }
                        }
                    }
                }
            });

            function normalize(newWeights) {
                let total = newWeights.reduce((a,b) => a+b, 0);
                if (total === 0) total = 1;
                let scale = 100000 / total;
                for (let i=0;i<newWeights.length;i++) {
                    newWeights[i] = Math.round(newWeights[i] * scale);
                }
                return newWeights;
            }

            function updateDisplay() {
                const sum = weights.reduce((a,b) => a+b,0);
                rows.forEach((row, i) => {
                    row.weightInput.value = weights[i];
                    row.slider.value = weights[i];
                    row.percentInput.value = ((weights[i]/sum*100)).toFixed(2);
                    const percent = (weights[i] / sum * 100).toFixed(2);
                    if (frequency !== null) {
                        row.freqTd.textContent = String(Number(((frequency * percent)/100).toFixed(8)));
                    } else {
                        row.freqTd.textContent = '-';
                    }
                });
                chart.data.datasets[0].data = weights;
                chart.update();
            }

            function redistribute(index, newValue) {
                weights[index] = newValue;
                const freeIndices = [];
                let fixedTotal = weights[index];
                rows.forEach((r, i) => {
                    if (i !== index) {
                        if (r.fixCheck.checked) {
                            fixedTotal += weights[i];
                        } else {
                            freeIndices.push(i);
                        }
                    }
                });
                let freeSum = freeIndices.reduce((a,b)=>a+weights[b],0);
                let remaining = 100000 - fixedTotal;
                if (remaining < 0) remaining = 0;
                freeIndices.forEach(i => {
                    const proportion = freeSum > 0 ? weights[i]/freeSum : 1/freeIndices.length;
                    weights[i] = Math.round(remaining * proportion);
                });
                weights = normalize(weights);
                updateDisplay();
            }

            rows.forEach((row, i) => {
                row.weightInput.addEventListener('blur', e => {
                    redistribute(i, parseInt(e.target.value)||0);
                });
                row.slider.addEventListener('input', e => {
                    redistribute(i, parseInt(e.target.value)||0);
                });
                row.percentInput.addEventListener('blur', e => {
                    const percent = parseFloat(e.target.value)||0;
                    const newValue = Math.round(percent/100*100000);
                    redistribute(i, newValue);
                });
            });

            updateDisplay();

            function downloadFeature(identifier) {
                const featObj = {
                    format_version: f.raw.format_version,
                    "minecraft:weighted_random_feature": {
                        description: { identifier },
                        features: rows.map((r, i) => [r.name, weights[i]])
                    }
                };
                const blob = new Blob([JSON.stringify(featObj, null, 4)], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = (identifier.split(':')[1] || identifier) + ".json";
                a.click();
            }
        }

        function downloadAll() {
            Object.values(features).forEach(f => {
                if (f.identifier === activeFeature) {
                    downloadFeature(f.identifier);
                }
            });
        }
    </script>
</body>
</html>